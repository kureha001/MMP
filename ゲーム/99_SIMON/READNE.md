# 🧠 ネットSIMONゲームSYSTEM

## 🔷 概要
**田中氏**が開発した`SIMONボード`をネットワーク対応しました。
マイコンをESP32S3に交換し、`WebAPI`を搭載しています。  

`主催者`はWEBブラウザで作られた`ダッシュボード`を用い、試合を進行します。
各`プレイヤー`は主催者の指示に従い、`SIMONボード`でプレイします。

---
## 🧩 システム構成
|層  |名称              |役割                |📁ファイル|
|--- |------------------|--------------------|-----------|
|Ｂ層|ビジネスロジック  |ゲーム進行の中枢    |main.py    |
|Ｄ層|データベース      |共有データベース    |Data.py    |
|Ｎ層|ネットワーク      |Wi-Fi接続管理       |Network.py |
|Ｆ層|ファンクション    |WebAPIサーバ (HTTP) |Function.py|
|Ｐ層|プレゼンテーション|画面・音・LED制御   |Presen.py  |

- **B層（Business Logic）**  
  状態遷移を統括する中核ロジック。  
  状況ID（`idle` / `standby` / `playing` / `finish` / `ending`）に応じて  
  処理と画面更新を制御します。

- **D層（Data）**  
  グローバル変数群。ネットワーク情報・出題・進捗・結果を保持。  
  全レイヤーから共通アクセス可能なデータベース的役割。

- **N層（Network）**  
  Wi-Fi設定ファイル（`wifi.json`）を読み込み、  
  ネットワーク初期化を担当。接続状況をOLEDに表示します。

- **F層（Function）**  
  内蔵Webサーバを起動し、HTTP GET/POSTのリクエストに応答。  
  `/info`, `/assign`, `/begin`, `/status`, `/result` の5APIを提供。  
  各APIは D層を更新し、状態遷移をトリガーします。

- **P層（Presentation）**  
  OLED表示、LED制御、サウンド出力、ボタン入力を一括管理。  
  UI（物理的インタフェース）を抽象化する層です。

---
## ⚙️ 特徴

- **完全レイヤー分割設計**  
  各モジュールが明確な責務を持ち、相互依存を最小化。  
  デバッグや拡張が容易な構造。

- **状態駆動アーキテクチャ**  
  プレイヤー操作／WebAPI通信の両経路から  
  状況IDを更新し、B層のIF分岐で動作を制御。

- **マルチスレッド対応**  
  WebAPIサーバ（F層）は `_thread` により並列実行され、  
  ゲーム処理との干渉を防止。

- **物理UI統合**  
  LED・サウンド・OLED・ボタン入力をP層で抽象化し、  
  ロジック層がデバイス仕様に依存しない設計。

- **WebAPI制御**  
  主催者からのHTTPリクエストに応じて  
  リアルタイムに競技進行・状況監視・結果通知を行う。

-----
# 🌐 WebAPI インタフェース一覧
`ダッシュボード`と`SIMONボード`はWebAPIを通して通信します。　 
|項目      |説明                           |
|----------|-------------------------------|
|ポート番号|8080                           |
|方式      |JSONベース / GET・POST         |
|レスポンス|application/json               |
|方向      |`ダッシュボード`→`SIMONボード`|

---
## ① /info   [GET] 参加者情報要求
**目的** : プレイヤー名を取得（エントリー確認用）  
**Request** : なし  
**Response** : `{"name": "<player_name>"}`  
**状態** : idle維持（変化なし）

---
## ② /assign [POST] 参加受理通知
**目的** : 主催側が背番号を通知  
**Request** : `{"no": <int>}`  
**Response** : `{"ok": true}`  
**状態** : idle → standby  
**表示** : READY #XXX

---
## ③ /begin  [POST] ゲーム開始通知
**目的** : 出題と制限を送信して競技開始  
**Request** :
```json
{
  "seq": [0,1,2,3],
  "lim_time": 10000,
  "lim_miss": 3,
  "penalty": 600
}
```
**Response** : `{"ok": true}`  
**状態** : standby → playing  
**動作** : LED+音で出題を再生、計測開始

---
## ④ /status [GET] ゲーム状況要求
**目的** : 進捗・ミス数を取得（監視用）  
**Request** : なし  
**Response** :
```json
{
  "state": "idle|standby|playing|finish|ending",
  "step": <int>,
  "miss": <int>
  "time": <int>
}
```
**状態** : 変化なし（監視のみ）

---
## ⑤ /result [POST] ゲーム結果通知
**目的** : 主催側から順位・参加数を通知  
**Request** :
```json
{
  "順位": <int>,   // 1=優勝, -1=失格
  "nums": <int>    // 参加人数
}
```
**Response** : `{"ok": true}`  
**状態** : finish → ending  
**表示** : [RESULT] No.X/Y

---
## 🌀 状態管理
このゲームシステムは`状態ID`を中心に、ゲームの進行を管理します。
`状態ID`は`SIMONクライアント`が保持しており、値に応じた**処理シーケンスを制御**します。

| 状態ID | 概要 | 画面制御 |
|:--|:--|:--|
| idle    | Wi-Fi完了後、初期画面(ONLINE) | **登録待ち画面**を表示 |
| standby | READY表示（開始待ち） | **開始待ち画面**を表示 |
| playing | 出題・入力判定・進行中 | **プレイ画面**を表示 |
| finish  | 終了（タイムアップ／クリア） | **終了画面**を表示 |
| ending  | 結果表示中 | **結果画面**を表示 |

---
## 🧩 状態IDの更新

### ダッシュボードによる状態IDの更新
`ダッシュボード`の操作(WebAPI)に応じ、状態IDを更新します。

| WebAPI | 状態ＩＤ |
|:--|:--|
|GET  /info  |更新しない     |
|POST /assign|`standby`に更新|
|POST /begin |`playing`に更新|
|GET  /status|更新しない     |
|POST /result|`ending`に更新 |

### ダッシュボードによる状態IDの更新
`SIMONクライアント`は、**プレイ状況**に応じて状態IDを更新します。

| SIMONクライアント | 状態ＩＤ |
|:--|:--|
|全問正解した|`finish`に更新|
|時間切れになった|`finish`に更新|
|ミス回数の上限を超えた|`finish`に更新|