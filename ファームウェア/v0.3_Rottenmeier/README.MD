# Rottenmeier ファームウェア コマンド一覧
コマンドを実行すると、必ず何らかの5文字の戻り値があります。<BR><BR>

**(コマンド実行)**<BR>
・コマンドは、コマンド名(3文字)で指定します<BR>
・引数が必要な物は、区切り文字(`:`)を加えます<BR>
・末尾には、終端文字(`!`)を加えます<BR><BR>

**(戻り値)**<BR>
正常と異常のコード、どちらかを戻します<BR>
・コマンド**実行が異常**の場合、`<コマンド名>!!`(異常)を戻します<BR>
・コマンドが**不明/引数違反**の場合、`<コマンド名>?!`(異常)を戻します<BR>
・**取得値のない**コマンドの場合、`!!!!!`(正常)を戻します<BR>
・**取得値のある**コマンドの場合、`xxxx!`(16進数)を戻します<BR>

## アナログ入力関連
**4個のHC4067**を搭載し、合計**64ch**(16chx4)のアナログ入力をおこないます。<BR>
以下の順序でアナログ値を取得します。<BR>
・`ANS`コマンドで、取得範囲をセット<BR>
・`ANU`コマンドで、その時点のアナログ値をバッファ<BR>
・`ANR`コマンドで、必要な箇所のアナログ値を参照<BR>
・必要に応じて、1番目か2番目から繰り返し<BR>
| コマンド | 引数                                                  | 概要                  | 戻り値                  |
|----------|-------------------------------------------------------|-----------------------|-------------------------|
| `ANS`    | `CH`=プレイヤー数(1-16)<br> `MUX`=スイッチ数(1-4)     | アナログ入力の設定    | `!!!!!`正常/`ANS!!`異常 |
| `ANU`    | なし                                                  | アナログ値を一括更新  | `!!!!!`正常             |
| `ANR`    | `CH`=プレイヤー番号(0-15)<br> `MUX`=スイッチ番号(0-3) | 1つのアナログ値を返す | `XXXX!`正常/`ANR!!`異常 |

## デジタル入出力関連
MMPのマイコンボードのGPIOからデジタル入出力をおこないます。<BR>
ユーザに解放されたGPIOは`3`/`6`/`7`になります。
| コマンド | 引数         | 概要                   | 戻り値                  |
|----------|--------------|------------------------|-------------------------|
| `POW`    | `PORT`,`VAL` | GPIOピンへ出力         | `!!!!!`正常/`ANS!!`異常 |
| `POR`    | `PORT`       | GPIOピンの入力値を取得 | `XXXX!`正常/`ANS!!`異常 |
| `IO`     | `PORT`,`VAL` | 出力後、入力値を取得   | `XXXX!`正常/`ANS!!`異常 |

## ＰＷＭ関連
**最大16個のPCA9685**を搭載でき、**1個あたり16ch**のPWM出力をおこないます。<BR>
MMPのGlove端子(GPIO`4`,`5`)でi2c接続します。<BR>
外部5Vを入力できるので、5Vのリレーツイッチのような使い方(`VAL=4095`)も可能です。<BR>
PWIコマンドを実行しなくても、一般的なサーボ(SG90の)の内容をデフォルト設定しています。<BR>
| コマンド | 引数                                                     | 概要                    | 戻り値                  |
|----------|----------------------------------------------------------|-------------------------|-------------------------|
| `PWM`    | `CH`=チャンネル番号(0-255)<br> `VAL`=出力値(0-4095)      | 指定チャンネルへPWM出力 | `!!!!!`正常/`PWM!!`異常 |
| `PWR`    | `CH`=チャンネル番号(0-255)<br> `RAD`=角度(0-180)         | 指定チャンネルへPWM出力 | `!!!!!`正常/`PWR!!`異常 |
| `PWI`    | `MIN`=サーボが0度のPWM値<br> `MAX`==サーボが180度のPWM値 | 指定チャンネルへPWM出力 | `!!!!!`正常/`PWI!!`異常 |

## ＭＰ３関連
**2個のDFPlayer mini**を搭載し、ＭＰ３ファイルの再生をおこないます。<BR>
２台同時の再生が可能です。<BR><BR>
**(注意点)**<BR>
・MMPのGPIO`8(TX)`,`9(RX)`で 1台目のDFPlayerをシリアル通信します。<BR>
・MMPのGPIO`0(TX)`,`1(RX)`で 2台目のDFPlayerをシリアル通信します。<BR>
※GPIOシリアルで外部と通信する場合、1台目のDFPlayerのみが利用できます。
| コマンド       | 引数形式                       | 説明               | 戻り値                             |
| -------------- | ------------------------------ | ------------------ | ---------------------------------- |
| `DPL:id:nn`    | `id`=1～2<br>`nn`=曲番号       | 指定曲を再生       | `!!!!!`正常/`DPL!!`異常            |
| `DSP:id`       | `id`=1～2                      | 再生を停止         | `!!!!!`正常/`DSP!!`異常            |
| `DPA:id`       | `id`=1～2                      | 再生を一時停止     | `!!!!!`正常/`DPR!!`異常            |
| `DPR:id`       | `id`=1～2                      | 再生を再開         | `!!!!!`正常/`DQT!!`異常            |
| `DQT:id`       | `id`=1～2                      | 現在の曲番号を取得 | `xxxx!`(4桁Hex)/`DQT!!`異常        |
| `DST:id`       | `id`=1～2                      | 再生状態を取得     | `xxxx!`(再生中/停止中)/`DQT!!`異常 |
| `DTC:id`       | `id`=1～2                      | 曲の総数を取得     | `xxxx!`(4桁Hex)        `DQT!!`異常 |
| `DEF:id:nn`    | `id`=1～2<br>`nn`=EQ番号(0～5) | EQ設定(Normal/Pop/Rock/...)             | `!!!!!`正常/`DPL!!`異常 |
| `DIR:id:ff:ss` | `id`=1～2<br>`ff`=フォルダ番号<br>`ss`=曲番号 | 指定フォルダ内の曲を再生 | `!!!!!`正常/`DPL!!`異常 |
| `DRP:id:nn`    | `id`=1～2<br>`nn`=曲番号       | 曲をループ再生     | `!!!!!`正常/`DPL!!`異常            |
| `VOL:id:nn`    | `id`=1～2<br>`nn`=音量(0～30)  | 音量設定           | `!!!!!`正常/`DPL!!`異常            |

## I2C関連
MMPのGPIO`4(SDA)`,`5(SCL)`でI2C通信します。
| コマンド | 引数               | 概要                       | 戻り値                  |
|----------|--------------------|----------------------------|-------------------------|
| `I2W`    | `ADDR`,`REG`,`VAL` | I2Cバスへ書き込み          | `!!!!!`正常/`I2W!!`異常 |
| `I2R`    | `ADDR`,`REG`       | I2Cバスから1バイト読み込み | `!!!!!`正常/`I2R!!`異常 |

## システム確認情報
各種システム情報を確認します。
アプリケーション側で、事前に機器(PCA9685/DFPlyer)の接続情報を確認する際に用います。
| コマンド | 内容                          | 戻り値                                            |
| -------- | ----------------------------- | ------------------------------------------------- |
| `VER!`   | ファームウェアのバージョン    | `xyzz!` `x`:メジャー `y`:マイナー `zz`:リビジョン |
| `PWX:3!` | PCA9865の機器ID=3 の接続状況  | `0001!`接続あり/`0000!`接続なし                   |
| `DPX:1!` | DFPlayerの機器ID=1 の接続状況 | `0001!`接続あり/`0000!`接続なし                   |

## その他
誤って、**存在しないコマンド**を実行したり、**引数が不足**する場合、以下のコードを戻します。
| コマンド | 内容         | 戻り値  |
| -------- | -------------| --------|
| `abc`    | 間違えた指定 | `abc?!` |

---
# シリアル通信設定

## 概要

**起動時に使用するシリアルポート(USB/GPIOシリアル)・通信速度を選択**する仕組みを備えています。<BR>
これにより、ユーザーは**用途に応じた通信方法を選択**できます。

## 通信方式の選択
※GPIOはファームウェアで内部プルアップを指定済み
| シリアル種別 | スイッチ1 | 抵抗状態                          | 使用ポート               |
|--------------|-----------|-----------------------------------|--------------------------|
| USBシリアル  | `GPIO2`   | **プルアップ状態**`HIGH`         | `Serial`                 |
| GPIOシリアル | `GPIO2`   | **プルダウン or オープン**`LOW` | `Serial1`(`TX=0`,`RX=1`) |

## 通信速度の選択
※GPIOはファームウェアで内部プルアップを指定済み
| スイッチ2(`GPIO14`) | スイッチ3(`GPIO15`) | ボーレート |
| ----------------- | ----------------- | ---------- |
| OFF               | OFF               | 115200     |
| ON                | OFF               | 9600       |
| OFF               | ON                | 230400     |
| ON                | ON                | 921600     |

---
# GPIOシリアルでの接続方法
## USBシリアルモジュールと MMP の接続表
| USBシリアルモジュール | 接続 | MMPピン          |
| --------------------- | -- | ------------------ |
| TX                    | → | GPIO1 (Serial1 RX) |
| RX                    | ← | GPIO0 (Serial1 TX) |
| GND                   | → | GND                |
| 3.3V または 5V        | → | 3.3V または VBUS   |

## シリアル選択ピンの設定
| MMPピン | 接続先 |
| ------- | ------ |
| GPIO2   | GND    |

## シリアル通信設定(TeraTermなど)
| 項目               | 設定値          |
| ------------------ | --------------- |
| ボーレート         | スイッチ2,3参照 |
| データビット       | 8               |
| パリティ           | なし            |
| ストップビット     | 1               |
| フロー制御         | なし            |
| 改行コード(送信)   | CR+LF           |
| 改行コード(受信)   | 自動判別        |
| 文字コード         | UTF-8(推奨)     |

---
# 使用例

## 使用例(アナログ入力)
TeraTermから以下の順に入力。
送受信の数値は16進数でやり取りするので、ユーザ側で適宜10進数に変換ください。
反応が !!!!! や XXXX!(16進数)なら正常動作です。
```
ANS:0F:04!      ← 16人分、4スイッチ
ANU!            ← 全アナログ入力更新(バッファに格納される)
ANR:01:02!      ← プレイヤー1のスイッチ2の値をバッファから参照(例：02F3!)
```
