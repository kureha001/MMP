# ファームウェア コマンド一覧

コードネーム：Rottenmeier(ロッテンマイヤー)がもつコマンド群のリファレンスマニュアルです。

---
## 戻り値
コマンドを実行すると、**必ず5文字**の戻り値があります。

**(コマンド実行)**
- コマンドは、コマンド名(3文字)で指定
- 引数が必要な物は、区切り文字（`:`）を付加
- 末尾には、終端文字（`!`）を付加

**(戻り値)**  
正常と異常のコード、どちらかを戻します。**いずれも5文字固定**です。  

|種別|戻り値|概要|
|----|------|----|
|正常|`!!!!!`|**取得値のない**コマンドの場合|
||`XXXX!`<BR>(`16進4桁＋'!'`)|**取得値のある**コマンドの場合|
|異常|`<コマンド名>!!`|**処理で異常が発生**|
||`<コマンド名>?!`|**コマンド名が不明か、引数の誤り**|

**(数値表記の規約)**  
送受信する数値は **16進・大文字・ゼロ埋め固定桁**で表記します。例：ID/ポート=`%02X`、角度=`%03X`、PWM/戻り値=`%04X`。

---

## アナログ入力関連
**4個のHC4067**を搭載し、合計**64ch**（16ch×4）のアナログ入力をおこないます。  
以下の順序でアナログ値を取得します。

- `ANS`コマンドで、取得範囲をセット
- `ANU`コマンドで、その時点のアナログ値をバッファ
- `ANR`コマンドで、必要な箇所のアナログ値を参照
- 必要に応じて、1番目か2番目から繰り返し

| コマンド| 引数| 概要| 戻り値|
|----------|-------------------------------------------------------|-----------------------|-----------------------------|
| `ANS`| `CH`=プレイヤー数(1–16)<br>`MUX`=スイッチ数(1–4)| アナログ入力の設定| `!!!!!` 正常<br>`ANS!!` 異常|
| `ANU`| なし| アナログ値を一括更新| `!!!!!` 正常|
| `ANR`| `CH`=プレイヤー番号(0–15)<br>`MUX`=スイッチ番号(0–3)| スイッチ番号の<BR>アナログ値を返す| `XXXX!` 正常<br>`ANR!!` 異常|

> 備考：プレイヤー番号/スイッチ番号は **0始まり** です。

---

## デジタル入出力関連
MMPのマイコンボードのGPIOからデジタル入出力をおこないます。  
（ユーザに解放されたGPIOは `3` / `6` / `7`）

| コマンド| 引数| 概要| 戻り値|
|----------|--------------|------------------------|-----------------------------|
| `POW`| `PORT`<BR>`VAL`| GPIOピンへ出力| `!!!!!` 正常<br>`POW!!` 異常|
| `POR`| `PORT`| GPIOピンの入力値を取得| `XXXX!` 正常<br>`POR!!` 異常|
| `IO`| `PORT`<BR>`VAL`| 出力後、入力値を取得| `XXXX!` 正常<br>`IO!!`  異常|

---

## ＰＷＭ関連（PCA9685）
**最大16個のPCA9685**を搭載でき、**1個あたり16ch**のPWM出力をおこないます。  
I2Cは MMP の GPIO `4(SDA)`・`5(SCL)` を使用します。  
外部5Vを入力できるため、5Vリレーを `VAL=4095` で駆動するような使い方も可能です。  
`PWI` を実行しない場合、一般的なサーボ（SG90相当）の内容をデフォルト設定しています。

| コマンド| 引数     | 概要| 戻り値|
|----------|----------------------------------------------------------------------|------------------------------|-----------------------------|
| `PWM`| `CH`=チャンネル番号(0–255)<BR>`VAL`=出力値(0–4095,`%04X`)| 指定チャンネルへ<BR>PWM出力| `!!!!!` 正常<br>`PWM!!` 異常|
| `PWA`| `CH`=チャンネル番号(0–255)<BR>`ANG`=角度(0–180,`%03X`)| 指定チャンネルへ<BR>角度指定出力| `!!!!!` 正常<br>`PWA!!` 異常|
| `PWI`| `RS`=開始角(0–360,`%03X`)<BR>`RE`=終了角(0–360,`%03X`)<BR>`PS`=開始PWM(0–4095,`%04X`)<BR>`PE`=終了PWM(0–4095,`%04X`)| サーボ特性<BR>(角度↔PWM)設定| `!!!!!` 正常<br>`PWI!!` 異常|

> 備考：現在はボード全体の特性を設定します（将来、各ch個別設定に拡張予定）。

---

## ＭＰ３関連（DFPlayer mini）
**2個のDFPlayer mini**を搭載し、MP3ファイルの再生をおこないます（同時再生可）。

**(接続注意)**
- GPIO `8(TX)`,`9(RX)`： 1台目のDFPlayer用
- GPIO `0(TX)`,`1(RX)`： 2台目のDFPlayer用
- GPIOシリアルで外部と通信する場合、1台目のDFPlayerのみが利用可能

| コマンド| 引数形式| 説明| 戻り値|
|-----------------|--------------------------------------------|-------------------------------------------------------------|--------------------------------------|
| `DIR:id:ff:ss`| `id`=1–2<BR>`ff`=フォルダ<BR>`ss`=曲番号| 指定フォルダ内<BR>の曲を再生| `!!!!!` 正常<BR>`DIR!!` 異常|
| `DSP:id`| `id`=1–2| 再生を停止| `!!!!!` 正常<BR>`DSP!!` 異常|
| `DPA:id`| `id`=1–2| 再生を一時停止| `!!!!!` 正常<BR>`DPA!!` 異常|
| `DPR:id`| `id`=1–2| 再生を再開| `!!!!!` 正常<BR>`DPR!!` 異常|
| `DEF:id:eq`| `id`=1–2<BR>`eq`=EQ(0–5)| EQ設定<BR>・0:Normal<BR>・1:Pop<BR>・2:Rock<BR>・3:Jazz<BR>・4:Classic<BR>・5:Bass| `!!!!!` 正常<BR>`DEF!!` 異常|
| `VOL:id:nn`| `id`=1–2<BR>`nn`=音量(0–30)| 音量設定| `!!!!!` 正常<BR>`VOL!!` 異常|
| `DST:id:st`| `id`=1–2<BR>`st`=状態項目(1–5)| 状態取得<BR>・1:再生状態<BR>・2:音量<BR>・3:EQ<BR>・4:総ファイル数<BR>・5:現在番号）| `XXXX!` 正常<BR>`DST!!` 異常|

> 備考：`DPL` / `DQT` / `DTC` / `DRP` などは未実装です。

---

## I2C関連
MMPのGPIO `4(SDA)`,`5(SCL)` でI2C通信します。

| コマンド| 引数| 概要| 戻り値|
|----------|----------------------|----------------------------|-----------------------------|
| `I2W`| `ADDR`<BR>`REG`<BR>`VAL`| I2Cバスへ<BR>1バイト書き込み| `!!!!!` 正常<BR>`I2W!!` 異常|
| `I2R`| `ADDR`<BR>`REG`| I2Cバスから<BR>1バイト読み込み| `XXXX!` 正常<BR>`I2R!!` 異常|

---

## システム確認情報
各種システム情報を確認します。アプリケーション側で、事前に機器（PCA9685/DFPlayer）の接続情報を確認する際に用います。

| コマンド| 内容| 戻り値|
|-----------|--------------------------------------|-----------------------------------------------------|
| `VER!`| ファームウェアの<BR>バージョン| `xyzz!`<BR>・`x`:メジャー<BR>・`y`:マイナー<BR>・`zz`:リビジョン）|
| `PWX:id!`| PCA9685 の<BR>**機器ID=0–15**の接続状況| `0001!` 接続あり<BR>`0000!` 接続なし|
| `DPX:id!`| DFPlayer の<BR>**機器ID=1–2**の接続状況| `0001!` 接続あり<BR>`0000!` 接続なし|

---

# シリアル通信設定

## 概要
**起動時に使用するシリアルポート（USB/GPIOシリアル）・通信速度を選択**する仕組みを備えています。  
用途に応じた通信方法を選択できます。

## 通信方式の選択
※GPIOはファームウェアで内部プルアップを指定済み

| シリアル種別| スイッチ1| 抵抗状態| 使用ポート|
|--------------|-----------|-------------------------------|----------------------------|
| USBシリアル| `GPIO2`| **プルアップ状態** `HIGH`| `Serial`|
| GPIOシリアル| `GPIO2`| **プルダウン状態<BR>オープン** `LOW`| `Serial1`<BR>（TX=0,RX=1）|

## 通信速度の選択
※GPIOはファームウェアで内部プルアップを指定済み

| スイッチ2（`GPIO14`）| スイッチ3（`GPIO15`）| ボーレート|
|-----------------------|-----------------------|------------|
| OFF| OFF| 115200|
| ON| OFF| 9600|
| OFF| ON| 230400|
| ON| ON| 921600|

---

# GPIOシリアルでの接続方法

## USBシリアルモジュールと MMP の接続表
| USBシリアルモジュール| 接続| MMPピン|
|-----------------------|------|--------------------|
| TX| →| GPIO1 (Serial1 RX)|
| RX| ←| GPIO0 (Serial1 TX)|
| GND| →| GND|
| 3.3V または 5V| →| 3.3V または VBUS|

## シリアル選択ピンの設定
| MMPピン| 接続先|
|---------|--------|
| GPIO2| GND|

## シリアル通信設定（TeraTermなど）
| 項目| 設定値|
|----------------|-----------------|
| ボーレート| スイッチ2,3参照|
| データビット| 8|
| パリティ| なし|
| ストップビット| 1|
| フロー制御| なし|
| 改行コード(送)| CR+LF|
| 改行コード(受)| 自動判別|
| 文字コード| UTF-8（推奨）|

---

# 使用例

## 例：アナログ入力す方法
TeraTermから以下の順に入力。
数値は16進数でやり取りします。
反応が `!!!!!` または `XXXX!`（16進）なら正常です。

```
ANS:10:04!      ← 16人分(0x10),4スイッチ
ANU!            ← 全アナログ入力更新（バッファに格納）
ANR:01:02!      ← プレイヤー1のスイッチ2の値（例：02F3!）
```
