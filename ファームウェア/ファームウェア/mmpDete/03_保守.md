# 📘 保守マニュアル（RAII版）

> バージョン：**0.4.01**（2025/10/07）  
> コードネーム：**Dete（デーテ）**  
> 対象：Waveshare **RP2040 Zero / RP2350 Zero**

本書は MMP ファームウェアの**現行構成（RAII + コンテクスト + ルーター + モジュール）**での保守手引きです。

---

## 1. システム概要

- **複数ストリーム同時待受**：USB(Serial) と UART0(Serial1) を**同時にポーリング**し、受信終端 `'!'` で1コマンド確定 → ルーティング。  
- **モジュール分割**：機能は `ModuleBase` を継承した各モジュールに実装。  
- **RAIIガード**：
  - `SerialScope`…処理区間だけ**出力先ストリームを一時切り替え**、スコープ終了で自動復元  
  - `LedScope`……処理区間だけ**NeoPixel点灯**、スコープ終了で自動消灯
- **プロトコル**：
  - 受信：`:` 区切りトークン（最大5個×各10文字、行最大96文字）＋終端 `'!'`  
  - 応答：コマンドにより可変（例：`VER` は `"0401!"`）。未定義コマンドは `"XXX?!"` 形式で返却

---

## 2. アーキテクチャ（構成要素）

- **MmpContext**（`ModuleBase.h`）
  - 共有状態（現在のクライアントID、現在の `Stream*`、`Adafruit_NeoPixel*`、`versionStr`）
  - ヘルパ：`inline Stream& MMP_SERIAL(ctx)` で**現在選択中ストリーム**へ出力
- **RAIIガード**（`ModuleBase.h`）
  - `SerialScope(ctx, stream, clientIndex)`：区間中のみ `ctx.serial/currentClient` を切替  
  - `LedScope(ctx, LedColor)`：区間中のみ NeoPixel 点灯（GRB順）
- **コマンドルーター**（`Perser.h`）
  - `addSource(Stream*, name, id)`：クライアント追加  
  - `addModule(ModuleBase*)`：モジュール追加  
  - `pollAll()`：全クライアントから**終端 `'!'` まで**取り込み、`runCommand()` へ  
  - `runCommand()`：`:` でトークン化 → `SerialScope` で出力先切替 → `modules` 走査し `owns()` / `handle()` 実行
- **モジュール**（各 `Module*.h`）
  - `class ModuleX : public ModuleBase`  
  - `bool owns(const char* cmd) const` で担当コマンド名を判定  
  - `void handle(char dat[][10], int dat_cnt)` で処理本体（区間冒頭で `LedScope led_guard(ctx, led);` を推奨）

---

## 3. ファイル一覧と役割（現行）

| ファイル名 | 役割 |
|---|---|
| `mmpDete.ino` | エントリポイント。ボーレート決定、LED初期表示、シリアル初期化、モジュール/クライアント登録、メインループで `g_router.pollAll()` 実行 |
| `Perser.h` | **ルーター**本体。複数 `Stream` の終端受信→トークン化→モジュールディスパッチ |
| `ModuleBase.h` | 共有**コンテクスト**、**RAIIガード**（`SerialScope`/`LedScope`）、モジュール基底クラス、**LEDパレット定義** |
| `ModuleInfo.h` | 情報系（例：`VER` 応答） |
| `ModuleAnalog.h` | アナログ入力 |
| `ModuleDigital.h` | GPIO デジタル入出力 |
| `ModulePwm.h` | PWM／サーボ角度／ローテーションサーボ |
| `ModuleI2C.h` | I2C 読み書き |
| `ModuleMP3.h` | DFPlayer 制御（※モジュール内部で UART を初期化する想定） |

> 旧版で分離されていた **`LedScope.h / SerialScope.h / LedPalette.h / CommandRouterMulti.h` は統合**され、現行では主に **`ModuleBase.h` と `Perser.h`** に集約されています。

---

## 4. コマンドの追加／修正／削除

### 追加（既存モジュール）
1. 対象 `ModuleX.h` を開く  
2. `owns()` に新コマンド名を判定追加  
3. `handle()` に処理分岐を追加  
   - 先頭で `LedScope led_guard(ctx, led);`（点灯区間の可視化）  
   - **出力は `MMP_SERIAL(ctx)` 経由**（ルーターが `SerialScope` 済み）  
4. 応答仕様を満たす（成功/失敗の整合）。未定義コマンドはルーター側で `"XXX?!"` 返却済み

### 修正
- `handle()` 内のロジックを更新。**引数数 `dat_cnt` と各トークン長（≤10）**を厳密チェック

### 削除
- `owns()` の該当名を外し、`handle()` 側の分岐を削除

> 受信制限：`MMP_INPUT_LINE_LENGTH=96`、`MMP_INPUT_DAT_COUNT=5`、`MMP_INPUT_DAT_LENGTH=10`（`Perser.h`）

---

## 5. モジュールの追加／削除

### 追加
1. `ModuleX.h` を作成し `ModuleBase` を継承
2. `owns()` と `handle()` を実装  
   - `handle()` 冒頭に `LedScope led_guard(ctx, led);`  
3. `mmpDete.ino` の `setup()` で登録  
   ```cpp
   g_router.addModule(new ModuleX(g_ctx, LED_PALETTE_XXXX));
   ```
4. 必要に応じて `ModuleBase.h` の LED パレットに色を追加

### 削除
- `setup()` の `addModule(new ModuleX(...))` を削除し、不要な `#include` を外す

> メモ：`addModule(new ...)` は**ヒープ確保**です。ファームのライフタイムと同一でリーク実害はありませんが、将来の動的 unload を見据えるなら `std::unique_ptr` 化を検討。

---

## 6. ルーターと入出力

- **クライアント登録**（`setup()`）
  ```cpp
  g_router.addSource(&Serial,  "USB",   0);
  g_router.addSource(&Serial1, "UART0", 1);
  ```
- **受信～実行**  
  `pollAll()` が各 `Stream` をポーリング → `'!'` で1コマンド確定 →  
  `runCommand()` が `:` で分割 → `SerialScope` で出力先切替 → `modules` 走査  
- **未定義コマンド**  
  先頭3文字＋`"?!"` を返却（例：`"ABC?!"`）

---

## 7. ボーレート設定と LED 表示（起動時）

- **DIP/SW**：`SW_PIN_A=2`、`SW_PIN_B=6`、`SW_PIN_C=7`（`INPUT_PULLUP`）  
- **組合せで 8段階**：`BAUD_PRESETS = {921600, 57600, 38400, 19200, 9600, 4800, 2400, 300}`  
- **色表示**：`BAUD_COLORS`（GRB順で設定）。起動直後に現在設定を NeoPixel 0番へ点灯

---

## 8. 実装ガイド（小さな約束事）

- **出力は常に `MMP_SERIAL(ctx)`**：出力先はルーターが `SerialScope` で切替済み
- **区間の可視化**：各 `handle()` の冒頭で `LedScope` を置き、**早期 return でも自動消灯**を保証
- **NeoPixel 色順**：`pixels->Color( **G, R, B** )`（GRB順）に注意
- **トークン長**：各 `dat[i]` は **最大9文字＋終端**。超過は切り捨てられる（送信側仕様の徹底）
- **命名**：RAII 変数は `*_guard`（例：`serial_guard` / `led_guard`）で統一すると可読性向上

---

## 9. 変更履歴（抜粋）

- **0.4.01（2025/09/29）**  
  - デジタル I/O：`POR` コマンド復活  
  - PWM：角度指定コマンド新設／ローテーションサーボ用コマンド新設  
  - ルーター／モジュール体系を**RAII＋複数ストリーム同時待受**へ再編成

---

### 付記（命名のゆらぎについて）
- 旧文書での `DF`／現行コードの `MP3` など、**モジュール名の呼称ゆらぎ**が見られます。  
  実体ファイル名（`ModuleMP3.h` など）に合わせて**一貫化**してください。
