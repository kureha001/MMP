<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1280" height="660" viewBox="0 0 1280 660">
  <style>
    .b{fill:#fff;stroke:#111;stroke-width:2}
    .m{fill:#f7f7f7;stroke:#111;stroke-width:2}
    .t{font-family:Arial,Helvetica,sans-serif;font-size:14px}
    .h{font-weight:bold}
    .a{marker-end:url(#arrow)}
    .ab{marker-start:url(#arrow);marker-end:url(#arrow)}
    .d{stroke-dasharray:6 5}
    /* Type fills */
    .io{fill:#e7f0ff}        /* I/O Blue */
    .core{fill:#e9fbea}      /* Core Green */
    .mod{fill:#fff1db}       /* Module Orange */
    .sup{fill:#f3eaff}       /* Support Purple */
    .grp{fill:#f9fbff}       /* Group frame */
  </style>
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="8" refX="9" refY="4" orient="auto">
      <path d="M0,0 L10,4 L0,8 Z" fill="#111"/>
    </marker>
  </defs>

  <!-- クライアント（I/O） -->
  <rect x="20" y="70" width="180" height="70" class="b io"/>
  <text x="35" y="100" class="t h">クライアントA</text>
  <text x="35" y="120" class="t">ゲーム／アプリ側</text>

  <rect x="20" y="170" width="180" height="70" class="b io"/>
  <text x="35" y="200" class="t h">クライアントB</text>
  <text x="35" y="220" class="t">ゲーム／アプリ側</text>

  <!-- シリアルポート（グループ枠） -->
  <rect x="230" y="50" width="180" height="210" class="g d grp"/>
  <text x="240" y="70" class="t h">シリアルポート（0／1）</text>

  <!-- シリアル0 -->
  <rect x="240" y="90" width="160" height="70" class="b io"/>
  <text x="255" y="120" class="t h">シリアル0</text>

  <!-- シリアル1 -->
  <rect x="240" y="180" width="160" height="70" class="b io"/>
  <text x="255" y="210" class="t h">シリアル1</text>

  <!-- ファームウェア本体（高さ 約1/6 縮小：580→490） -->
  <rect x="420" y="20" width="820" height="490" rx="10" class="m"/>
  <text x="435" y="45" class="t h">MMPファームウェア（Arduino）</text>

  <!-- 初期化（コア） -->
  <rect x="440" y="80" width="210" height="60" class="b core"/>
  <text x="450" y="110" class="t h">初期化＆起動</text>
  <text x="450" y="130" class="t">自動ボーレート・LED初期化</text>

  <!-- パーサ（コア） -->
  <rect x="440" y="170" width="210" height="90" class="b core"/>
  <text x="450" y="200" class="t h">パーサー</text>
  <text x="450" y="220" class="t">コマンド解析＆振り分け</text>

  <!-- モジュール基底（モジュール枠） -->
  <rect x="700" y="170" width="210" height="60" class="b mod"/>
  <text x="710" y="200" class="t h">モジュール基底クラス</text>
  <text x="710" y="220" class="t">owns()／handle()を実装</text>

  <!-- 派生モジュール群（少し左へ：x=1040→x=1000） -->
  <rect x="1000" y="60" width="210" height="300" class="g mod"/>
  <text x="1010" y="85" class="t h">各モジュール</text>
  <text x="1010" y="105" class="t">ModuleBaseを継承</text>

  <rect x="1010" y="120" width="190" height="36" class="b mod"/>
  <text x="1020" y="142" class="t h">システム情報</text>

  <rect x="1010" y="162" width="190" height="36" class="b mod"/>
  <text x="1020" y="184" class="t h">アナログ入力</text>

  <rect x="1010" y="204" width="190" height="36" class="b mod"/>
  <text x="1020" y="226" class="t h">デジタルI/O</text>

  <rect x="1010" y="246" width="190" height="36" class="b mod"/>
  <text x="1020" y="268" class="t h">PWM／サーボ</text>

  <rect x="1010" y="288" width="190" height="36" class="b mod"/>
  <text x="1020" y="310" class="t h">MP3再生</text>

  <!-- サポートレイヤ（高さ 1/4 縮小：240→180） -->
  <rect x="440" y="300" width="470" height="180" class="g sup"/>
  <text x="450" y="325" class="t h">サポートレイヤ（内部処理）</text>

  <!-- コンテクスト -->
  <rect x="460" y="350" width="210" height="80" class="b sup"/>
  <text x="470" y="375" class="t h">コンテクスト</text>
  <text x="470" y="395" class="t">共有状態＆ルーティング情報</text>

  <!-- RAIIガード（短幅のまま） -->
  <rect x="700" y="350" width="190" height="110" class="b sup"/>
  <text x="710" y="375" class="t h">RAIIガード群</text>
  <text x="710" y="395" class="t">SerialScope</text>
  <text x="710" y="415" class="t">LedScope</text>
  <text x="710" y="435" class="t">TimingScope（将来）</text>

  <!-- 矢印 -->
  <!-- クライアント⇄シリアル -->
  <line x1="200" y1="105" x2="240" y2="105" class="ab" stroke="#111"/>
  <line x1="200" y1="205" x2="240" y2="205" class="ab" stroke="#111"/>

  <!-- シリアル0⇄パーサ（独立の双方向） -->
  <line x1="400" y1="125" x2="440" y2="205" class="ab" stroke="#111"/>

  <!-- シリアル1⇄パーサ（独立の双方向） -->
  <line x1="400" y1="215" x2="440" y2="215" class="ab" stroke="#111"/>

  <!-- パーサ⇄モジュール基底（双方向） -->
  <line x1="650" y1="200" x2="700" y2="200" class="ab" stroke="#111"/>

  <!-- ModuleBase → 各モジュール（派生の示唆：破線） -->
  <line x1="910" y1="200" x2="1000" y2="200" class="a d" stroke="#111"/>
  <text x="880" y="195" class="t">← 派生</text>

  <!-- パーサ→サポート層（短いカーブ） -->
  <path d="M545,260 C520,300 520,300 565,350" fill="none" stroke="#111" class="a"/>
  <path d="M585,260 C615,300 715,300 750,350" fill="none" stroke="#111" class="a"/>

  <!-- 凡例 -->
  <text x="30" y="620" class="t">
    【凡例】青：入出力（クライアント／シリアル）／緑：コア（初期化・パーサ）／橙：モジュール構成（基底・派生）／紫：サポート（コンテクスト・RAII）
  </text>
</svg>
