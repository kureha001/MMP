# Rottenmeier ファームウェア コマンド一覧 (Ver 0.3)

## 🔶 アナログ入力関連

| コマンド | 引数                        | 概要                              | 戻り値      |
|----------|-----------------------------|-----------------------------------|-------------|
| `ANS`    | `CH` = プレイヤー数 (1-16) <br> `MUX` = スイッチ数 (1-4) | アナログ入力の設定（配列初期化含む） | `!!!!!` または `ANS!!` |
| `ANU`    | なし                        | 全スイッチのアナログ値を一括更新         | `!!!!!`     |
| `ANR`    | `CH` = プレイヤー番号 (0-15) <br> `MUX` = スイッチ番号 (0-3) | 指定した1つのアナログ値を返す           | `XXXX!` または `----!` |

## 🔷 PWM関連（PCA9685）

| コマンド | 引数                              | 概要                         | 戻り値          |
|----------|-----------------------------------|------------------------------|-----------------|
| `PWM`    | `CH` = チャンネル番号 (0-255) <br> `VAL` = 出力値 (0-4095) | 指定チャンネルへPWM出力        | `!!!!!` または `PWS!!` |

## 🔸 デジタル入出力関連

| コマンド | 引数                              | 概要                         | 戻り値        |
|----------|-----------------------------------|------------------------------|---------------|
| `POW`    | `PORT`, `VAL`                     | GPIOピンへ出力               | `!!!!!`       |
| `POR`    | `PORT`                            | GPIOピンの入力値を取得        | `XXXX!`       |
| `IO`     | `PORT`, `VAL`                     | 出力後、入力として再読み込み   | `XXXX!`       |

## 🔊 DFPlayer関連

| コマンド | 引数                       | 概要                     | 戻り値            |
|----------|----------------------------|--------------------------|-------------------|
| `DPL`    | `N` = 再生するファイル番号 | 単独ファイル再生           | `!!!!!`           |
| `DSP`    | なし                       | 再生停止                   | `!!!!!`           |
| `DPA`    | なし                       | 一時停止                   | `!!!!!`           |
| `DPR`    | なし                       | 再開                       | `!!!!!`           |
| `DQT`    | なし                       | 現在再生中のファイル番号取得 | `XXXX!` または `----!` |
| `DST`    | なし                       | DFPlayerの状態取得         | `XXXX!` または `----!` |
| `DTC`    | なし                       | 総ファイル数取得            | `XXXX!` または `----!` |
| `DEF`    | `EQ` = EQモード            | EQモードの設定              | `!!!!!`           |
| `DIR`    | `FOLDER`, `FILE`           | フォルダ内再生              | `!!!!!`           |
| `DRP`    | `N` = ループ再生ファイル番号 | 単独ループ再生              | `!!!!!`           |
| `VOL`    | `N` = 音量（0〜30）        | 音量設定                    | `!!!!!`           |

## 🧩 その他/I2C関連

| コマンド | 引数                              | 概要                         | 戻り値        |
|----------|-----------------------------------|------------------------------|---------------|
| `I2W`    | `ADDR`, `REG`, `VAL`              | I2Cバスへ書き込み             | `!!!!!`       |
| `I2R`    | `ADDR`, `REG`                     | I2Cバスから1バイト読み込み     | `XXXX!`       |
| `VER`    | なし                               | バージョンを返す              | `9999!`       |


# シリアル切替機能

## 概要

`mmpRottenmeier` ファームウェアでは、**起動時に使用するシリアルポート（USB または GPIOシリアル）を自動選択**する仕組みを備えています。これにより、ユーザーは配線や用途に応じて柔軟に通信方法を切り替えることが可能です。

---

## 選択方法

| シリアル種別 | MMPピン     | 抵抗状態             | 使用ポート    |
|--------------|--------------|----------------------|----------------|
| USBシリアル   | GPIO2        | **プルアップ状態**（HIGH） | `Serial`       |
| GPIOシリアル  | GPIO2        | **プルダウン or オープン**（LOW） | `Serial1` (`TX=0`, `RX=1`) |

初期化時の処理（`setup()`関数内）：

```
cpp

#define SERIAL_SELECT_PIN 2
pinMode(SERIAL_SELECT_PIN, INPUT_PULLUP);
delay(10);
bool useUSB = digitalRead(SERIAL_SELECT_PIN);

if (useUSB) {
  Serial.begin(115200);
  serialPort = &Serial;
} else {
  Serial1.setTX(0);
  Serial1.setRX(1);
  Serial1.begin(115200);
  serialPort = &Serial1;
}
```

# GPIOシリアルの接続方法

## USBシリアルモジュールと MMP の接続表

| USBシリアルモジュール | 接続 | MMPピン        |
| ------------ | -- | ------------------ |
| TX           | →  | GPIO1 (Serial1 RX) |
| RX           | ←  | GPIO0 (Serial1 TX) |
| GND          | →  | GND                |
| 3.3V または 5V  | →  | 3.3V または VBUS      |

## シリアル選択ピンの設定
| MMPピン | 抵抗   | 接続先 |
| -------- | ---- | --- |
| GPIO2    | 10kΩ | GND |
※内部プルアップをファームウェアで指定済み...抵抗が無くても大丈夫のはず

## シリアル通信設定（TeraTermなど）
| 項目        | 設定値        |
| --------- | ---------- |
| ボーレート     | 115200 bps |
| データビット    | 8          |
| パリティ      | なし         |
| ストップビット   | 1          |
| フロー制御     | なし         |
| 改行コード（送信） | CR+LF      |
| 改行コード（受信） | 自動判別       |
| 文字コード     | UTF-8（推奨）  |

# クイックリファレンス
## アナログ関連
| コマンド  | 引数（HEX）                            | 内容                |
| ----- | ---------------------------------- | ----------------- |
| `ANS` | CH:プレイヤー数（0～F）<br>MUX:スイッチ数（1～4）   | アナログ入力の構成を指定（初期化） |
| `ANU` | なし                                 | アナログ入力全体を一括更新     |
| `ANR` | CH:プレイヤー番号（0～F）<br>MUX:スイッチ番号（0～3） | 指定の値を取得（4桁16進＋!）  |

## 使用例
```
ANS:0F:04!      ← 16人分、4スイッチ
ANU!            ← 全アナログ入力更新
ANR:01:02!      ← プレイヤー1のスイッチ2の値を取得（例：02F3!）
```

## テストのヒント
TeraTermから以下の順に入力
```
ANS:10:04!
ANU!
ANR:0A:03!
```
反応が !!!!! や XXXX!（16進数）なら正常動作です。