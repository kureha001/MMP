# Rottenmeier ファームウェア コマンド一覧 (Ver 0.3)

## 🔶 アナログ入力関連

| コマンド | 引数                        | 概要                              | 戻り値      |
|----------|-----------------------------|-----------------------------------|-------------|
| `ANS`    | `CH` = プレイヤー数 (1-16) <br> `MUX` = スイッチ数 (1-4) | アナログ入力の設定（配列初期化含む） | `!!!!!` または `ANS!!` |
| `ANU`    | なし                        | 全スイッチのアナログ値を一括更新         | `!!!!!`     |
| `ANR`    | `CH` = プレイヤー番号 (0-15) <br> `MUX` = スイッチ番号 (0-3) | 指定した1つのアナログ値を返す           | `XXXX!` または `----!` |

## 🔷 PWM関連（PCA9685）

| コマンド | 引数                              | 概要                         | 戻り値          |
|----------|-----------------------------------|------------------------------|-----------------|
| `PWM`    | `CH` = チャンネル番号 (0-255) <br> `VAL` = 出力値 (0-4095) | 指定チャンネルへPWM出力        | `!!!!!` または `PWS!!` |

## 🔸 デジタル入出力関連

| コマンド | 引数                              | 概要                         | 戻り値        |
|----------|-----------------------------------|------------------------------|---------------|
| `POW`    | `PORT`, `VAL`                     | GPIOピンへ出力               | `!!!!!`       |
| `POR`    | `PORT`                            | GPIOピンの入力値を取得        | `XXXX!`       |
| `IO`     | `PORT`, `VAL`                     | 出力後、入力として再読み込み   | `XXXX!`       |

## 🔊 DFPlayer関連

| コマンド | 引数                       | 概要                     | 戻り値            |
|----------|----------------------------|--------------------------|-------------------|
| `DPL`    | `N` = 再生するファイル番号 | 単独ファイル再生           | `!!!!!`           |
| `DSP`    | なし                       | 再生停止                   | `!!!!!`           |
| `DPA`    | なし                       | 一時停止                   | `!!!!!`           |
| `DPR`    | なし                       | 再開                       | `!!!!!`           |
| `DQT`    | なし                       | 現在再生中のファイル番号取得 | `XXXX!` または `----!` |
| `DST`    | なし                       | DFPlayerの状態取得         | `XXXX!` または `----!` |
| `DTC`    | なし                       | 総ファイル数取得            | `XXXX!` または `----!` |
| `DEF`    | `EQ` = EQモード            | EQモードの設定              | `!!!!!`           |
| `DIR`    | `FOLDER`, `FILE`           | フォルダ内再生              | `!!!!!`           |
| `DRP`    | `N` = ループ再生ファイル番号 | 単独ループ再生              | `!!!!!`           |
| `VOL`    | `N` = 音量（0〜30）        | 音量設定                    | `!!!!!`           |

## 🧩 その他/I2C関連

| コマンド | 引数                              | 概要                         | 戻り値        |
|----------|-----------------------------------|------------------------------|---------------|
| `I2W`    | `ADDR`, `REG`, `VAL`              | I2Cバスへ書き込み             | `!!!!!`       |
| `I2R`    | `ADDR`, `REG`                     | I2Cバスから1バイト読み込み     | `XXXX!`       |
| `VER`    | なし                               | バージョンを返す              | `9999!`       |


# シリアル切替機能

## 概要

`mmpRottenmeier` ファームウェアでは、**起動時に使用するシリアルポート（USB または GPIOシリアル）を自動選択**する仕組みを備えています。これにより、ユーザーは配線や用途に応じて柔軟に通信方法を切り替えることが可能です。

---

## 選択方法

| シリアル種別 | MMPピン     | 抵抗状態             | 使用ポート    |
|--------------|--------------|----------------------|----------------|
| USBシリアル   | GPIO2        | **プルアップ状態**（HIGH） | `Serial`       |
| GPIOシリアル  | GPIO2        | **プルダウン or オープン**（LOW） | `Serial1` (`TX=0`, `RX=1`) |

初期化時の処理（`setup()`関数内）：

```
cpp

#define SERIAL_SELECT_PIN 2
pinMode(SERIAL_SELECT_PIN, INPUT_PULLUP);
delay(10);
bool useUSB = digitalRead(SERIAL_SELECT_PIN);

if (useUSB) {
  Serial.begin(115200);
  serialPort = &Serial;
} else {
  Serial1.setTX(0);
  Serial1.setRX(1);
  Serial1.begin(115200);
  serialPort = &Serial1;
}
```

# GPIOシリアルの接続方法

## USBシリアルモジュールと MMP の接続表

| USBシリアルモジュール | 接続 | MMPピン        |
| ------------ | -- | ------------------ |
| TX           | →  | GPIO1 (Serial1 RX) |
| RX           | ←  | GPIO0 (Serial1 TX) |
| GND          | →  | GND                |
| 3.3V または 5V  | →  | 3.3V または VBUS      |

## シリアル選択ピンの設定
| MMPピン | 抵抗   | 接続先 |
| -------- | ---- | --- |
| GPIO2    | 10kΩ | GND |
※内部プルアップをファームウェアで指定済み...抵抗が無くても大丈夫のはず

## シリアル通信設定（TeraTermなど）
| 項目        | 設定値        |
| --------- | ---------- |
| ボーレート     | 115200 bps |
| データビット    | 8          |
| パリティ      | なし         |
| ストップビット   | 1          |
| フロー制御     | なし         |
| 改行コード（送信） | CR+LF      |
| 改行コード（受信） | 自動判別       |
| 文字コード     | UTF-8（推奨）  |

# 使用例：IchigoJamとの組み合わせ

## 接続表
| IchigoJam  | 接続 | RP2040-Zero        |
| ---------- | -- | ------------------ |
| IN1 (RXD)  | ←  | GPIO0 (Serial1 TX) |
| OUT1 (TXD) | →  | GPIO1 (Serial1 RX) |
| GND        | ↔  | GND                |
| 3.3V       | →  | 3.3V               |

## IchigoJam 側の受信サンプルコード（ANRコマンド送信例）
※ INPUT A$ は受信1行を IchigoJam 側で取り込む基本命令です。
文字列を取り出して値を抽出する場合は VAL() 関数や MID$() 関数を併用します。
```
' ANUコマンドを送信して、アナログ値を更新
OUT1 "ANU!"

' プレイヤー0、スイッチ0 の値を取得
OUT1 "ANR:00:00!"

' 結果を表示（受信処理が必要）
INPUT A$
?"RECV=";A$
```

## 通信設定（IchigoJam側）
IchigoJam は OUT1 で送信、IN1 で受信できます。
送受信は 1バイトずつ行われるため、**応答に "!" を必ず付ける仕様（ファームウェア）**は IchigoJam でも扱いやすくなっています。
| 項目      | 設定値        |
| ------- | ---------- |
| 通信速度    | 115200 bps |
| データ長    | 8ビット       |
| パリティ    | なし         |
| ストップビット | 1ビット       |
| 改行コード   | CR+LF      |

## サンプルプログラム
「MMP/サンプル/IJB/」をご利用ください。
https://github.com/kureha001/MMP/tree/main/%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB/IJB
