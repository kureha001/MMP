# Rottenmeier ファームウェア コマンド一覧 (Ver 0.3)

## アナログ入力関連(４つの HC4067 を搭載；合計64ch(16ch x 4)が使用可能)

| コマンド | 引数 | 概要                             | 戻り値  |
|----------|------|----------------------------------|---------|
| `ANS`    | `CH` = プレイヤー数 (1-16) <br> `MUX` = スイッチ数 (1-4) | アナログ入力の設定(配列初期化含む) | `!!!!!` または `ANS!!` |
| `ANU`    | なし | 全スイッチのアナログ値を一括更新 | `!!!!!` |
| `ANR`    | `CH` = プレイヤー番号 (0-15) <br> `MUX` = スイッチ番号 (0-3) | 指定した1つのアナログ値を返す | `XXXX!` または `----!` |

## PWM関連(最大16つの PCA9685 を搭載可能;増設可能;1台当たり16ch,最大256chが使用可能)
MMPのGlove端子(GPIO4,5)でi2c接続します。
| コマンド | 引数                                                  | 概要                     | 戻り値                 |
|----------|--------------------------------------------------------|-------------------------|------------------------|
| `PWM`    | `CH`=チャンネル番号 (0-255) <br> `VAL`=出力値 (0-4095) | 指定チャンネルへPWM出力 | `!!!!!` または `PWS!!` |

## デジタル入出力関連

| コマンド | 引数          | 概要                         | 戻り値  |
|----------|---------------|------------------------------|---------|
| `POW`    | `PORT`, `VAL` | GPIOピンへ出力               | `!!!!!` |
| `POR`    | `PORT`        | GPIOピンの入力値を取得       | `XXXX!` |
| `IO`     | `PORT`, `VAL` | 出力後、入力として再読み込み | `XXXX!` |

## DFPlayer関連(2台の DFPlayer mini を搭載し同時再生が可能)
MMPのGPIO8をDFPlayer(TX),9(RX)でシリアル通信接続します。
| コマンド       | 引数形式                           | 説明               | 戻り値                         |
| -------------- | ---------------------------------- | ------------------ | ------------------------------ |
| `DFA:id`       | `id` = 1～2                        | DFPlayer接続確認   | `0001!`(接続)，`0000!`(未接続) |
| `DPL:id:nn`    | `id` = 1～2<br>`nn` = 曲番号       | 指定曲を再生       | `!!!!!`                        |
| `DSP:id`       | `id` = 1～2                        | 再生を停止         | `!!!!!`                        |
| `DPA:id`       | `id` = 1～2                        | 再生を一時停止     | `!!!!!`                        |
| `DPR:id`       | `id` = 1～2                        | 再生を再開         | `!!!!!`                        |
| `DQT:id`       | `id` = 1～2                        | 現在の曲番号を取得 | `xxxx!`(4桁Hex)                |
| `DST:id`       | `id` = 1～2                        | 再生状態を取得     | `xxxx!`(再生中/停止中)         |
| `DTC:id`       | `id` = 1～2                        | 曲の総数を取得     | `xxxx!`(4桁Hex)                |
| `DEF:id:nn`    | `id` = 1～2<br>`nn` = EQ番号(0～5) | EQ設定(Normal/Pop/Rock/...) | `!!!!!`               |
| `DIR:id:ff:ss` | `id` = 1～2<br>`ff` = フォルダ番号<br>`ss` = 曲番号 | 指定フォルダ内の曲を再生 | `!!!!!` |
| `DRP:id:nn`    | `id` = 1～2<br>`nn` = 曲番号       | 曲をループ再生     | `!!!!!`                        |
| `VOL:id:nn`    | `id` = 1～2<br>`nn` = 音量(0～30)  | 音量設定           | `!!!!!`                        |

## その他/I2C関連

| コマンド | 引数                 | 概要                       | 戻り値  |
|----------|----------------------|----------------------------|---------|
| `I2W`    | `ADDR`, `REG`, `VAL` | I2Cバスへ書き込み          | `!!!!!` |
| `I2R`    | `ADDR`, `REG`        | I2Cバスから1バイト読み込み | `XXXX!` |
| `VER`    | なし                 | バージョンを返す           | `9999!` |

## 確認情報
| コマンド      | 内容                     | 応答例                                        |
| --------- | ---------------------------- | --------------------------------------------- |
| `VER!`    | ファームウェアのバージョン   | `xyzz!` x:メジャー／y:マイナー／zz:リビジョン |
| `PWX:03!` | PCA9865の機器ID=3 の接続状況 | `0001!`(接続あり)または `0000!`(接続なし) |
| `DPX:00!` | DFPlayerの機器ID=0 の接続状況| `0001!`(接続あり)または `0000!`(接続なし) |

---
# シリアル通信設定

## 概要

**起動時に使用するシリアルポート(USB または GPIOシリアル)・通信速度を選択**する仕組みを備えています。これにより、ユーザーは配線や用途に応じて柔軟に通信方法を切り替えることが可能です。

## 通信方式の選択
| シリアル種別 | スイッチ1 | 抵抗状態                          | 使用ポート               |
|--------------|-----------|-----------------------------------|--------------------------|
| USBシリアル  | GPIO2     | **プルアップ状態**(HIGH)         | `Serial`                 |
| GPIOシリアル | GPIO2     | **プルダウン or オープン**(LOW) | `Serial1`(`TX=0`,`RX=1`) |
※GPIOはファームウェアで内部プルアップを指定済み

## 通信速度の選択
| スイッチ2(GPIO14) | スイッチ3(GPIO15) | ボーレート |
| ----------------- | ----------------- | ---------- |
| OFF               | OFF               | 115200     |
| ON                | OFF               | 9600       |
| OFF               | ON                | 230400     |
| ON                | ON                | 921600     |
※GPIOはファームウェアで内部プルアップを指定済み

---
# GPIOシリアルでの接続方法
## USBシリアルモジュールと MMP の接続表
| USBシリアルモジュール | 接続 | MMPピン          |
| --------------------- | -- | ------------------ |
| TX                    | → | GPIO1 (Serial1 RX) |
| RX                    | ← | GPIO0 (Serial1 TX) |
| GND                   | → | GND                |
| 3.3V または 5V        | → | 3.3V または VBUS   |

## シリアル選択ピンの設定
| MMPピン | 接続先 |
| ------- | ------ |
| GPIO2   | GND    |

## シリアル通信設定(TeraTermなど)
| 項目               | 設定値          |
| ------------------ | --------------- |
| ボーレート         | スイッチ2,3参照 |
| データビット       | 8               |
| パリティ           | なし            |
| ストップビット     | 1               |
| フロー制御         | なし            |
| 改行コード(送信)   | CR+LF           |
| 改行コード(受信)   | 自動判別        |
| 文字コード         | UTF-8(推奨)     |

---
# クイックリファレンス

## 使用例(アナログ入力)
TeraTermから以下の順に入力
反応が !!!!! や XXXX!(16進数)なら正常動作です。
```
ANS:0F:04!      ← 16人分、4スイッチ
ANU!            ← 全アナログ入力更新(バッファに格納される)
ANR:01:02!      ← プレイヤー1のスイッチ2の値をバッファから参照(例：02F3!)
```
