# 抽選処理 act特殊_選定 - 設計書

## 1. 概要
 `act特殊_選定()` は、ゲーム内アイテムの出現処理として、一定条件を満たすアイテムの中から `random.choices()` による重み付き抽選で1つを選定する処理です。

---

## 2. 入出力仕様

### 入力
関数内で静的に参照されるデータ：
- `main.DB.難易度`: ゲームの現在難易度（整数）
- `DS.obj.特殊効果.情報.発動中`: 発動中の効果ID辞書
    - キー：効果ID
    - 値：タプル `(持続時間, 登録値)`（登録値は数値）

- `アイテムDB`: アイテムごとの設定辞書
    - キー：アイテムID
    - 値：タプル `(効果ID, (出現難易度, 出現率), (持続性, 登録値/上限値))`

### 出力
- 抽選されたアイテムID（1件）または `None`

---

## 3. 抽選ロジックの流れ

### STEP 1: 初期化
- 抽選候補リスト `抽選候補` と、重みリスト `重みリスト` を初期化

### STEP 2: アイテムDBから抽選対象の抽出

- 出現難易度が現在難易度を超える → 除外
- 持続性が `-1`（使い切り） → 除外

#### 永続効果（持続性 == 0）の場合
- 発動中であり、登録値が上限値に達している → 除外
- 上限設定が存在しない（None や非タプル） → 除外

### STEP 3: 出現率の調整
- 発動中の効果IDについては、出現率を `// 2`（最低1）に調整

### STEP 4: 抽選箱に登録
- 対象アイテムIDを `抽選候補` に追加
- 出現率を `重みリスト` に追加

---

## 4. 抽選処理

- `random.choices(抽選候補, weights=重みリスト, k=1)` により、1件だけ重み付き抽選
- 候補が空であれば `None` を返す

---

## 5. 備考

- `random.choices()` により、明確かつシンプルな重み抽選が可能。
- 発動中の影響を1回だけ加味するため、複雑な履歴管理は不要。
- 拡張する場合は、カテゴリ・連続抽選・グループ制御などの機能追加が見込まれる。

