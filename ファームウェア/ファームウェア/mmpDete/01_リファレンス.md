# 📘シリアル通信 コマンド一覧

> バージョン：0.4<br>
> コードネーム：Date(デーテ)

本書はMMPに搭載する`マイコンのファームウェア`に関するコマンド一覧マニュアルです。

---
## 戻り値
コマンドを実行すると、**必ず5文字**の戻り値があります。

**(コマンド実行)**
- コマンドは、コマンド名(3文字)で指定
- 引数が必要な物は、区切り文字（`:`）を付加
- 末尾には、終端文字（`!`）を付加

**(戻り値)**  
正常と異常のコード、どちらかを戻します。**いずれも5文字固定**です。  

|種別|戻り値|概要|
|----|------|----|
|正常|`!!!!!`|**取得値のない**コマンドの場合|
||`XXXX!`<BR>(`16進4桁＋'!'`)|**取得値のある**コマンドの場合|
|異常|`<CMD>!!`|**処理で異常が発生**（例：無効な機器番号、範囲外値）|
|異常|`<CMD>?!`|**コマンド名が不明、または引数不足/不正**|

**(数値表記の規約)**  
送受信する数値は **16進・大文字・ゼロ埋め固定桁**で表記します。例：ID/ポート=`%02X`、角度=`%03X`、PWM/戻り値=`%04X`。

---

## アナログ入力関連
**4個のHC4067**を搭載し、合計**64ch**（16ch×4）のアナログ入力をおこないます。  
以下の順序でアナログ値を取得します。

- `ANS`コマンドで、取得範囲をセット
- `ANU`コマンドで、その時点のアナログ値をバッファ
- `ANR`コマンドで、必要な箇所のアナログ値を参照

| コマンド| 引数| 概要| 戻り値|
|----------|-------------------------------------------------------|-----------------------|-----------------------------|
| `ANS`| `CH`=プレイヤー数(1–16)<br>`MUX`=スイッチ数(1–4)<br>`ID`=クライアントID(0～)| アナログ入力の設定<br>`ID`省略で自信が対象| `!!!!!` 正常<br>`ANS!!` 異常|
| `ANU`| `ID`=クライアントID(0～)| アナログ値を一括更新<br>`ID`省略で自信が対象| `!!!!!` 正常|
| `ANR`| `CH`=プレイヤー番号(0–15)<br>`MUX`=スイッチ番号(0–3)<br>`ID`=クライアントID(0～)| 指定アナログ値を返す<br>`ID`省略で自信が対象| `XXXX!` 正常<br>`ANR!!` 異常|

---

## デジタル入出力関連
MMPのマイコンボードのGPIOからデジタル入出力をおこないます。  

| コマンド| 引数| 概要| 戻り値|
|----------|--------------|------------------------|-----------------------------|
| `POW`| `PORT`<BR>`VAL`| GPIOピンへ出力| `!!!!!` 正常<br>`POW!!` 異常|
| `POR`| `PORT`| GPIOピンの入力値を取得| `XXXX!` 正常<br>`POR!!` 異常|

---

## ＰＷＭ関連（PCA9685）
**最大16個のPCA9685**を搭載でき、**1個あたり16ch**のPWM出力をおこないます。  

| コマンド| 引数     | 概要| 戻り値|
|----------|----------------------------------------------------------------------|------------------------------|-----------------------------|
| `PWM`| `CH`=チャンネル番号(0–255)<br>`VAL`=出力値(0–4095)| PWM出力| `!!!!!` 正常<br>`PWM!!` 異常|
| `PWA`| `CH`=チャンネル番号(0–255)<br>`ANG`=角度(0–180)| サーボ角度 指定出力| `!!!!!` 正常<br>`PWA!!` 異常|
| `PAI`| `RS`=CH ID(開始)<BR>`RE`=CH ID(終了)<BR>`RE`=角度(最大)<BR>`PS`=PWM値(最小)<BR>`PE`=PWM値(最大)<BR>`PN`=PWM値(中間)| サーボ定格 登録<br>`PN`=`-1`で規定値設定| `!!!!!` 正常<br>`PAI!!` 異常|
| `PAD`| `RS`=CH ID(開始)<BR>`RE`=CH ID(終了)| サーボ定格 削除| `!!!!!` 正常<br>`PAD!!` 異常|
| `PAO`| `CH`=CH ID<BR>`R`=角度| サーボ角度指定| `!!!!!` 正常<br>`PAO!!` 異常|
| `PRI`| `RS`=CH ID(開始)<BR>`RE`=CH ID(終了)<BR>`RE`=角度(最大)<BR>`PS`=PWM値(最小)<BR>`PE`=PWM値(最大)<BR>`PN`=PWM値(中間)| ローテーション<br>サーボ定格 登録<br>`PN`=`-1`で規定値設定| `!!!!!` 正常<br>`PRI!!` 異常|
| `PRD`| `RS`=CH ID(開始)<BR>`RE`=CH ID(終了)| ローテーション<br>サーボ定格 削除| `!!!!!` 正常<br>`PRD!!` 異常|
| `PRO`| `CH`=CH ID<BR>`R`=角度| ローテーション<br>サーボ回転率 指定| `!!!!!` 正常<br>`PRO!!` 異常|

> 備考：無効なチャンネル番号/未接続機器の場合も `PWM!!` / `PWA!!` を返す。

---

## ＭＰ３関連（DFPlayer mini）
**1系統（Serial2固定）**のDFPlayer miniでMP3ファイルを再生します。  

| コマンド| 引数形式| 説明| 戻り値|
|-----------------|--------------------------------------------|-------------------------------------------------------------|--------------------------------------|
| `DIR:id:ff:ss`| `id`=1| 指定フォルダ内の曲を再生| `!!!!!` 正常<BR>`DIR!!` 異常|
| `DSP:id`| `id`=1| 再生を停止| `!!!!!` 正常<BR>`DSP!!` 異常|
| `DPA:id`| `id`=1| 再生を一時停止| `!!!!!` 正常<BR>`DPA!!` 異常|
| `DPR:id`| `id`=1| 再生を再開| `!!!!!` 正常<BR>`DPR!!` 異常|
| `DEF:id:eq`| `id`=1<BR>`eq`=EQ(0–5)| EQ設定| `!!!!!` 正常<BR>`DEF!!` 異常|
| `VOL:id:nn`| `id`=1<BR>`nn`=音量(0–30)| 音量設定| `!!!!!` 正常<BR>`VOL!!` 異常|
| `DST:id:st`| `id`=1<BR>`st`=1–5| 状態取得| `XXXX!` 正常<BR>`DST!!` 異常|

> 備考：`id` に無効な値を指定した場合も `XXX!!` 応答となる。

---

## I2C関連
GPIO `4(SDA)`,`5(SCL)` でI2C通信します。  

| コマンド| 引数| 概要| 戻り値|
|----------|----------------------|----------------------------|-----------------------------|
| `I2W`| `ADDR`<BR>`REG`<BR>`VAL`| 1バイト書き込み| `!!!!!` 正常<br>`I2W!!` 異常|
| `I2R`| `ADDR`<BR>`REG`| 1バイト読み込み| `XXXX!` 正常<br>`I2R!!` 異常|

> 備考：7bitアドレス以外を指定した場合や読取失敗時も `I2R!!` を返す。

---

## システム確認情報

| コマンド| 内容| 戻り値|
|-----------|--------------------------------------|-----------------------------------------------------|
| `VER!`| ファームウェアのバージョン| `030A!` など固定5文字|
| `PWX:id!`| PCA9685 の接続状況| `0001!` 接続あり<br>`0000!` 接続なし<br>`PWX!!` 異常|
| `DPX:id!`| DFPlayer の接続状況| `0001!` 接続あり<br>`0000!` 接続なし<br>`DPX!!` 異常|

---

## 🔔 旧バージョンからの変更点（重要）

旧バージョン(Rottenmeier)から今回のファームに移行した場合、以下の点に注意してください：

- **戻り値形式を統一**  
  - 成功：`!!!!!` または `XXXX!`（取得値あり）  
  - エラー：`<CMD>!!`（処理失敗）、`<CMD>?!`（不明コマンド/引数誤り）

- **PWMコマンド**  
  - 無効なチャンネル番号や未接続機器は `PWM!!` / `PWA!!` を返すように変更

- **DFPlayerコマンド**  
  - 利用ポートは **Serial2専用・1系統のみ** に変更  
  - 無効な `id` を指定した場合も `XXX!!` を返すよう統一

- **I2Cコマンド**  
  - アドレスは **7bit限定**  
  - 読取失敗時に `I2R!!` を返すよう変更

- **システム確認系 (PWX/DPX)**  
  - 無効なID指定時に `<CMD>!!` を返すよう変更
