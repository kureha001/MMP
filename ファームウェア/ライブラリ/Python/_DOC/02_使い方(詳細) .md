# Python版 アダプタ別の使い方

本書は **MMP.py** の使い方を、
利用シナリオごとに最短コードで示すリファレンスです。

---

## 目次
1. すぐ使う（最短）: `new_client()`
2. 直接アダプタを得る: `MmpAdapterFactory(conn=...)`
3. シナリオ別サンプル
   - 3.1 TCP（ser2net, socket://）
   - 3.2 直結 自動（CPython / MicroPython / CircuitPython）
   - 3.3 直結 CPython 固定（明示的に）
   - 3.4 直結 MicroPython 固定（明示的に）
   - 3.5 直結 CircuitPython 固定（明示的に）
4. エラーハンドリング例
5. ConnSpec 早見表
6. よくある質問（FAQ）

---

## 1. すぐ使う（最短）: `new_client()`

```python
from MMP import new_client

# TCP（ser2net / socket://）
cli = new_client("tcp://192.168.2.113:3331?timeout=0.2")

# 直結（実行系に応じてアダプタ自動選択）
cli = new_client("auto")

if cli.ConnectAutoBaud():
    print("VER :", cli.Info.Version())
else:
    print("接続失敗:", cli.LastError)
```

- `new_client(conn)` は `MmpClient(MmpAdapterFactory(conn))` のショートカットです。
- 上位API（Info/Digital/Analog/Pwm/I2C 等）は **既存のまま**利用できます。

---

## 2. 直接アダプタを得る: `MmpAdapterFactory(conn=...)`

```python
from mmp_core import MmpClient
from MMP      import MmpAdapterFactory

adapter = MmpAdapterFactory(conn="tcp://192.168.2.113:3331?timeout=0.2")
cli     = MmpClient(adapter)
```

- アダプタだけ欲しい場合や、自前のラッパで包む場合に便利です。

---

## 3. シナリオ別サンプル

### 3.1 TCP（ser2net, socket://）

```python
from MMP import new_client

# 基本形
cli = new_client("tcp://192.168.2.113:3331")

# タイムアウトを調整（秒）
cli = new_client("tcp://192.168.2.113:3331?timeout=0.5")

if cli.ConnectAutoBaud():
    print("Port:", cli.ConnectedPort)  # "tcp://192.168.2.113:3331"
    print("Baud:", cli.ConnectedBaud)  # 記録上の値（実通信はTCPのため無関係）
    print("VER :", cli.Info.Version())
```

**ポイント**
- `timeout` は **1文字読み**の待ち時間。ネットワーク品質に応じて調整。
- ser2net v3.x は全IF待受のため、LAN制御はファイアウォール側で。

---

### 3.2 直結 自動（CPython / MicroPython / CircuitPython）

```python
from MMP import new_client

# 実行系に応じて自動でアダプタを選択
cli = new_client("auto")

if cli.ConnectAutoBaud():
    print("Port:", cli.ConnectedPort)  # 例) "COM5" / "/dev/ttyACM0" / "tty.usbmodem..."
    print("VER :", cli.Info.Version())
```

**ポイント**
- CPython：COM/tty をスキャンして自動接続（既存の総当たりロジック）。
- Micro/Circuit：それぞれの実装に委譲。

---

### 3.3 直結 **CPython 固定**（明示的にアダプタを使う）

> ConnSpec を使わず、CPython用アダプタを直接 import する例。  
> 既存コードを温存したい場合向け。

```python
from mmp_core             import MmpClient
from mmp_adapter_cpython  import MmpAdapter

cli = MmpClient(MmpAdapter())
cli.ConnectAutoBaud()
```

---

### 3.4 直結 **MicroPython 固定**（明示的に）

```python
from mmp_core           import MmpClient
from mmp_adapter_micro  import MmpAdapter

cli = MmpClient(MmpAdapter())
cli.ConnectAutoBaud()
```

---

### 3.5 直結 **CircuitPython 固定**（明示的に）

```python
from mmp_core             import MmpClient
from mmp_adapter_circuit  import MmpAdapter

cli = MmpClient(MmpAdapter())
cli.ConnectAutoBaud()
```

---

## 4. エラーハンドリング例

```python
from MMP import new_client

cli = new_client("tcp://192.168.2.113:3331?timeout=0.5")

if not cli.ConnectAutoBaud():
    print("[ERROR] 接続できません:", cli.LastError)
else:
    try:
        print("VER:", cli.Info.Version())
    except Exception as e:
        print("[ERROR] 通信中に例外:", e)
    finally:
        cli.Close()
```

---

## 5. ConnSpec 早見表

| ConnSpec                     | 意味                                   | 例                                    |
|-----------------------------|----------------------------------------|---------------------------------------|
| `tcp://host:port`           | ser2net の raw TCP（socket://相当）    | `tcp://192.168.2.113:3331`            |
| `tcp://host:port?timeout=x` | 読み取りタイムアウトを秒で指定         | `tcp://192.168.2.113:3331?timeout=0.5`|
| `auto`                      | 実行系に応じた直結アダプタを自動選択   | `auto`                                |

---

## 6. よくある質問（FAQ）

**Q. `tcp://` で指定したボーレートは使われますか？**  
A. TCPでは物理ボーレートは不要です。`ConnectAutoBaud()` は互換のため値を保持しますが、実通信には影響しません。

**Q. どのアダプタが選択されたか確認したい**  
A. `cli.ConnectedPort` を表示してください（TCPなら `tcp://...`、直結なら物理ポート名）。

**Q. Micro/Circuit で `tcp://` を使えますか？**  
A. 将来的には専用アダプタで対応予定です。現状は `auto` による直結運用を想定しています。

**Q. 直結で接続できない**  
A. ケーブル／権限／ドライバ／ポート列挙の到達性をご確認ください。CPython では COM/tty の総当たりロジックを使用します。

---

以上で、**Factory 毎（`new_client` / `MmpAdapterFactory` / 明示アダプタ）の使い方**は完了です。
